{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Submit Your Song | PlugToPlaylists{% endblock %}

{% block extra_head %}
<!-- Add SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ff6600 0%, #1a1a1a 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow-x: hidden;
    }

    body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('https://images.unsplash.com/photo-1470225620780-dba8ba36b745?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
        background-size: cover;
        background-position: center;
        opacity: 0.1;
        z-index: -1;
    }

    .auth-container {
        background: rgba(26, 26, 26, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(255, 102, 0, 0.3);
        overflow: hidden;
        width: 90%;
        max-width: 1000px;
        min-height: 600px;
        display: flex;
        position: relative;
        border: 1px solid rgba(255, 102, 0, 0.2);
    }

    .auth-left {
        flex: 1;
        background: linear-gradient(45deg, #ff6600, #ff8533);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        position: relative;
        overflow: hidden;
    }

    .auth-left::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
        background-size: 30px 30px;
        animation: float 20s infinite linear;
    }

    @keyframes float {
        0% {
            transform: translateY(0) rotate(0deg);
        }

        100% {
            transform: translateY(-20px) rotate(360deg);
        }
    }

    .illustration {
        z-index: 2;
        text-align: center;
        color: white;
    }

    .illustration svg {
        width: 200px;
        height: 200px;
        margin-bottom: 20px;
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
    }

    .illustration h2 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 300;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .illustration p {
        font-size: 1.2rem;
        opacity: 0.9;
        line-height: 1.6;
    }

    .auth-right {
        flex: 1;
        padding: 60px 50px;
        background: rgba(26, 26, 26, 0.98);
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .auth-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .auth-header h1 {
        color: #ff6600;
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .auth-header p {
        color: #cccccc;
        font-size: 1.1rem;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        color: #ff6600;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .form-control {
        width: 100%;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 102, 0, 0.3);
        border-radius: 10px;
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #ff6600;
        background: rgba(255, 102, 0, 0.1);
        box-shadow: 0 0 20px rgba(255, 102, 0, 0.2);
    }

    .form-control::placeholder {
        color: #888888;
    }

    .btn-primary {
        width: 100%;
        padding: 15px;
        background: linear-gradient(45deg, #ff6600, #ff8533);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-primary:hover::before {
        left: 100%;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(255, 102, 0, 0.4);
    }

    .btn-link {
        color: #ff6600;
        text-decoration: none;
        font-size: 0.95rem;
        transition: color 0.3s ease;
    }

    .btn-link:hover {
        color: #ff8533;
        text-decoration: underline;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    .checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
        accent-color: #ff6600;
    }

    .checkbox-group label {
        color: #cccccc;
        font-size: 0.9rem;
        margin-bottom: 0;
    }

    .link-type-selector {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .link-input-container {
        display: flex;
        gap: 0.5rem;
    }

    .link-input-container input {
        flex: 1;
    }

    .btn-fetch {
        background: rgba(255, 102, 0, 0.2);
        border: 1px solid rgba(255, 102, 0, 0.5);
        color: #ff6600;
        padding: 0 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-fetch:hover {
        background: rgba(255, 102, 0, 0.3);
    }

    .file-upload {
        margin-top: 1rem;
    }

    .file-upload-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #ff6600;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .auth-container {
            flex-direction: column;
            margin: 20px;
            min-height: auto;
        }

        .auth-left {
            min-height: 200px;
        }

        .illustration svg {
            width: 120px;
            height: 120px;
        }

        .illustration h2 {
            font-size: 1.8rem;
        }

        .auth-right {
            padding: 40px 30px;
        }

        .auth-header h1 {
            font-size: 2rem;
        }
    }

    .song-details {
        background: rgba(255, 102, 0, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        border: 1px solid rgba(255, 102, 0, 0.3);
    }

    .song-details h4 {
        color: #ff6600;
        margin-bottom: 0.5rem;
    }

    .song-details p {
        margin-bottom: 0.5rem;
        color: #cccccc;
    }

    .song-details img {
        max-width: 100px;
        margin-top: 0.5rem;
        border-radius: 4px;
    }



    .song-details-card {
        background: rgba(255, 102, 0, 0.1);
        border: 1px solid rgba(255, 102, 0, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .song-details-card h4 {
        color: #ff6600;
        margin-bottom: 0.5rem;
    }

    .song-details-content {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .song-details-text {
        flex: 1;
    }

    .song-details-img {
        width: 80px;
        height: 80px;
        border-radius: 4px;
        object-fit: cover;
    }

    .payment-redirect {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-left">
        <div class="illustration">
            <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="80" fill="rgba(255,255,255,0.1)" />
                <path d="M80 70 L120 70 L120 130 L80 130 Z" stroke="white" stroke-width="8" stroke-linecap="round" />
                <path d="M100 70 L100 130" stroke="white" stroke-width="8" stroke-linecap="round" />
                <circle cx="100" cy="100" r="90" stroke="rgba(255,255,255,0.3)" stroke-width="2" />
                <circle cx="100" cy="100" r="70" stroke="rgba(255,255,255,0.2)" stroke-width="1" />
            </svg>
            <h2>Submit Your Music</h2>
            <p>Get your songs in front of thousands of new listeners through our curated playlists</p>
        </div>
    </div>

    <div class="auth-right">
        <div class="auth-header">
            <h1>Song Submission</h1>
            <p>Fill out the form to submit your track</p>
        </div>

        <form method="post" enctype="multipart/form-data" id="song-submission-form">
            {% csrf_token %}

            <div class="form-group">
                <label for="id_artist_name">Artist Name</label>
                <input type="text" name="artist_name" id="id_artist_name" class="form-control"
                    placeholder="Your artist name" required>
            </div>

            <div class="form-group">
                <label for="id_song_title">Song Title</label>
                <input type="text" name="song_title" id="id_song_title" class="form-control"
                    placeholder="Your song title" required>
            </div>

            <div class="form-group">
                <label for="id_genre">Genre</label>
                <select name="genre" id="id_genre" class="form-control" required>
                    <option value="">Select a genre</option>
                    <option value="pop">Pop</option>
                    <option value="hiphop">Hip Hop/Rap</option>
                    <option value="rnb">R&B</option>
                    <option value="edm">Electronic/Dance</option>
                    <option value="rock">Rock</option>
                    <option value="alternative">Alternative</option>
                    <option value="country">Country</option>
                    <option value="jazz">Jazz</option>
                    <option value="classical">Classical</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="id_email">Email Address</label>
                <input type="email" name="email" id="id_email" class="form-control" placeholder="Your email" required>
            </div>

            <div class="form-group">
                <label for="id_phone">Phone Number (optional)</label>
                <input type="tel" name="phone" id="id_phone" class="form-control" placeholder="Your phone number">
            </div>

            <div class="form-group">
                <label for="id_social_media">Social Media (Instagram/Twitter)</label>
                <input type="text" name="social_media" id="id_social_media" class="form-control"
                    placeholder="@yourhandle">
            </div>

            <div class="form-group">
                <label>Music Link</label>
                <div class="link-type-selector">
                    <div class="checkbox-group">
                        <input type="radio" id="spotify-link" name="link_type" value="spotify" checked>
                        <label for="spotify-link">Spotify</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="radio" id="youtube-link" name="link_type" value="youtube">
                        <label for="youtube-link">YouTube Music</label>
                    </div>
                </div>
                <div class="link-input-container">
                    <input type="url" name="music_link" id="id_music_link" class="form-control"
                        placeholder="Paste your Spotify or YouTube Music link" required>
                    <button type="button" class="btn-fetch" id="fetch-btn">Fetch</button>
                </div>
                <div class="song-details-card" id="song-details-card">
                    <h4>Fetched Song Details</h4>
                    <div class="song-details-content">
                        <img src="" alt="Album cover" class="song-details-img" id="song-details-img">
                        <div class="song-details-text">
                            <p><strong>Artist:</strong> <span id="song-details-artist"></span></p>
                            <p><strong>Title:</strong> <span id="song-details-title"></span></p>
                            <p><strong>Duration:</strong> <span id="song-details-duration"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="file-upload">
                    <label class="file-upload-label">Or upload your song file (optional)</label>
                    <input type="file" name="song_file" id="id_song_file" accept="audio/*">
                </div>
            </div>

            <div class="form-group">
                <label for="id_bio">Artist Bio (optional)</label>
                <textarea name="bio" id="id_bio" class="form-control" rows="4"
                    placeholder="Tell us about yourself and your music"></textarea>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="terms" name="terms" required>
                <label for="terms">I agree to the <a href="{% url 'landing:terms_page' %}" class="btn-link">Terms of
                        Service</a> and <a href="{% url 'landing:privacy_page' %}" class="btn-link">Privacy
                        Policy</a></label>
            </div>

            <button type="submit" class="btn-primary">Submit Song</button>
        </form>

        <!-- Hidden payment redirect form -->
        <form id="payment-redirect-form" class="payment-redirect" method="post" action="{% url 'payment:process' %}">
            {% csrf_token %}
            <input type="hidden" name="song_id" id="payment-song-id">
            <input type="hidden" name="amount" value="29.99">
        </form>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fetchBtn = document.getElementById('fetch-btn');
        const musicLinkInput = document.getElementById('id_music_link');
        const linkTypeRadios = document.querySelectorAll('input[name="link_type"]');
        const songForm = document.getElementById('song-submission-form');
        const artistNameInput = document.getElementById('id_artist_name');
        const songTitleInput = document.getElementById('id_song_title');
        const songDetailsCard = document.getElementById('song-details-card');
        const songDetailsImg = document.getElementById('song-details-img');
        const songDetailsArtist = document.getElementById('song-details-artist');
        const songDetailsTitle = document.getElementById('song-details-title');
        const songDetailsDuration = document.getElementById('song-details-duration');
        const paymentRedirectForm = document.getElementById('payment-redirect-form');
        const paymentSongId = document.getElementById('payment-song-id');

        // Format duration from milliseconds or ISO 8601
        function formatDuration(duration) {
            if (!duration) return 'N/A';

            // Handle Spotify duration (milliseconds)
            if (typeof duration === 'number') {
                const minutes = Math.floor(duration / 60000);
                const seconds = ((duration % 60000) / 1000).toFixed(0);
                return `${minutes}:${seconds.padStart(2, '0')}`;
            }

            // Handle YouTube duration (ISO 8601)
            if (duration.startsWith('PT')) {
                const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
                const hours = parseInt(match[1] || '0');
                const minutes = parseInt(match[2] || '0');
                const seconds = parseInt(match[3] || '0');

                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            return duration;
        }

        // Update placeholder based on selected link type
        linkTypeRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'spotify') {
                    musicLinkInput.placeholder = 'Paste your Spotify link (e.g., https://open.spotify.com/track/...)';
                } else {
                    musicLinkInput.placeholder = 'Paste your YouTube Music link (e.g., https://music.youtube.com/watch?v=...)';
                }
                songDetailsCard.style.display = 'none';
            });
        });

        // Fetch song data when fetch button is clicked
        fetchBtn.addEventListener('click', async function () {
            const link = musicLinkInput.value.trim();
            const linkType = document.querySelector('input[name="link_type"]:checked').value;

            if (!link) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Please paste a valid link first!',
                });
                return;
            }

            // Validate URL format
            if (linkType === 'spotify' && !link.includes('spotify.com/track/')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid URL',
                    text: 'Please enter a valid Spotify track URL (should contain "spotify.com/track/")',
                });
                return;
            }
            if (linkType === 'youtube' && !(link.includes('youtube.com/watch?v=') || link.includes('youtu.be/'))) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid URL',
                    text: 'Please enter a valid YouTube Music URL (should contain "youtube.com/watch?v=" or "youtu.be/")',
                });
                return;
            }

            // Show loading state
            fetchBtn.textContent = 'Fetching...';
            fetchBtn.disabled = true;
            songDetailsCard.style.display = 'none';

            try {
                // Get CSRF token
                const csrftoken = getCookie('csrftoken');

                const response = await fetch('{% url "landing:fetch_song_details" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: new URLSearchParams({
                        'link': link,
                        'link_type': linkType
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Auto-fill the form fields
                    artistNameInput.value = data.data.artist_name || '';
                    songTitleInput.value = data.data.song_title || '';

                    // Display song details
                    songDetailsImg.src = data.data.album_cover || data.data.thumbnail || '';
                    songDetailsImg.style.display = songDetailsImg.src ? 'block' : 'none';
                    songDetailsArtist.textContent = data.data.artist_name || 'N/A';
                    songDetailsTitle.textContent = data.data.song_title || 'N/A';
                    songDetailsDuration.textContent = formatDuration(data.data.duration_ms || data.data.duration);
                    songDetailsCard.style.display = 'block';

                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Song details fetched successfully!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(data.message || 'Could not fetch song details');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'An error occurred while fetching song details. Please check the link and try again.',
                });
            } finally {
                // Reset button
                fetchBtn.textContent = 'Fetch';
                fetchBtn.disabled = false;
            }
        });

        // Form submission handler
        songForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const termsChecked = document.getElementById('terms').checked;
            if (!termsChecked) {
                Swal.fire({
                    icon: 'error',
                    title: 'Required',
                    text: 'You must agree to the terms and conditions',
                });
                return;
            }

            // Get CSRF token from cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            // Show loading state
            Swal.fire({
                title: 'Submitting your song...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Submit the form data
                const formData = new FormData(songForm);
                const response = await fetch('{% url "landing:submit_song" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Your song has been submitted successfully!',
                        showConfirmButton: true,
                        confirmButtonText: 'Proceed to Payment'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Set the song ID for payment
                            paymentSongId.value = data.song_id;
                            // Submit the payment redirect form
                            paymentRedirectForm.submit();
                        }
                    });
                } else {
                    let errorMessage = data.message || 'There was an error submitting your song. Please try again.';
                    if (data.errors) {
                        errorMessage += '\n\n' + Object.values(data.errors).join('\n');
                    }
                    Swal.fire({
                        icon: 'error',
                        title: 'Submission Failed',
                        text: errorMessage,
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while submitting your song.',
                });
            }
        });
    });
</script>


<!-- <script>
    document.addEventListener('DOMContentLoaded', function () {
        const fetchBtn = document.getElementById('fetch-btn');
        const musicLinkInput = document.getElementById('id_music_link');
        const linkTypeRadios = document.querySelectorAll('input[name="link_type"]');
        const songForm = document.getElementById('song-submission-form');
        const artistNameInput = document.getElementById('id_artist_name');
        const songTitleInput = document.getElementById('id_song_title');
        const songDetailsContainer = document.createElement('div');
        songDetailsContainer.className = 'song-details';
        songDetailsContainer.style.marginTop = '1rem';
        songDetailsContainer.style.display = 'none';
        musicLinkInput.parentNode.insertBefore(songDetailsContainer, musicLinkInput.nextSibling);

        // Update placeholder based on selected link type
        linkTypeRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'spotify') {
                    musicLinkInput.placeholder = 'Paste your Spotify link (e.g., https://open.spotify.com/track/...)';
                } else {
                    musicLinkInput.placeholder = 'Paste your YouTube Music link (e.g., https://music.youtube.com/watch?v=...)';
                }
                songDetailsContainer.style.display = 'none';
            });
        });

        // Fetch song data when fetch button is clicked
        fetchBtn.addEventListener('click', async function () {
            const link = musicLinkInput.value.trim();
            const linkType = document.querySelector('input[name="link_type"]:checked').value;

            if (!link) {
                alert('Please paste a valid link first');
                return;
            }

            // Validate URL format
            if (linkType === 'spotify' && !link.includes('spotify.com/track/')) {
                alert('Please enter a valid Spotify track URL');
                return;
            }
            if (linkType === 'youtube' && !(link.includes('youtube.com/watch?v=') || link.includes('youtu.be/'))) {
                alert('Please enter a valid YouTube Music URL');
                return;
            }

            // Show loading state
            fetchBtn.textContent = 'Fetching...';
            fetchBtn.disabled = true;
            songDetailsContainer.style.display = 'none';

            try {
                const response = await fetch('/fetch-song-details/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        'link': link,
                        'link_type': linkType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Auto-fill the form fields
                    artistNameInput.value = data.data.artist_name || '';
                    songTitleInput.value = data.data.song_title || '';

                    // Display additional song details
                    songDetailsContainer.innerHTML = `
                    <div style="background: rgba(255,102,0,0.1); padding: 1rem; border-radius: 8px;">
                        <h4 style="color: #ff6600; margin-bottom: 0.5rem;">Song Details</h4>
                        <p><strong>Artist:</strong> ${data.data.artist_name || 'N/A'}</p>
                        <p><strong>Title:</strong> ${data.data.song_title || 'N/A'}</p>
                        ${data.data.album_cover ? `<img src="${data.data.album_cover}" style="max-width: 100px; margin-top: 0.5rem; border-radius: 4px;">` : ''}
                        ${data.data.thumbnail ? `<img src="${data.data.thumbnail}" style="max-width: 100px; margin-top: 0.5rem; border-radius: 4px;">` : ''}
                    </div>
                `;
                    songDetailsContainer.style.display = 'block';
                } else {
                    alert(data.message || 'Could not fetch song details. Please check the link and try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching song details.');
            } finally {
                // Reset button
                fetchBtn.textContent = 'Fetch';
                fetchBtn.disabled = false;
            }
        });

        // Form submission handler
        songForm.addEventListener('submit', function (e) {
            const termsChecked = document.getElementById('terms').checked;
            if (!termsChecked) {
                e.preventDefault();
                alert('You must agree to the terms and conditions');
            }
        });
    });
</script> -->


{% endblock %}